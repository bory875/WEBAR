(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))o(e);new MutationObserver(e=>{for(const i of e)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function h(e){const i={};return e.integrity&&(i.integrity=e.integrity),e.referrerPolicy&&(i.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?i.credentials="include":e.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(e){if(e.ep)return;e.ep=!0;const i=h(e);fetch(e.href,i)}})();let c={video:{facingMode:"environment",width:1280,height:720},audio:!1},r=document.getElementById("webcam"),d=document.getElementById("switchCamButton"),f=document.getElementById("transferCanvas");document.getElementById("displayCanvas");let p=document.getElementById("matchcount"),m=!1;function g(a){let t=a.cloneNode(!0);return a.parentElement.replaceChild(t,a),a.remove(),t}window.startAR=function(){cv2.then(t=>{class h{constructor(){this.matrices={},this.FPS=30,this.webcam=r,d=g(d)}onVideoLoaded(s){this.webcam=s,this.width=s.videoWidth,this.height=s.videoHeight,this.context=f.getContext("2d",{willReadFrequently:!0}),this.first=!0,this.context.canvas.width=this.width,this.context.canvas.height=this.height,this.matrices.rgba1=new t.Mat(this.height,this.width,t.CV_8UC4),this.matrices.rgba2=new t.Mat(this.height,this.width,t.CV_8UC4),this.matrices.image=t.imread(document.getElementById("image")),this.matrices.descriptors=new t.Mat,this.matrices.imageDescriptors=new t.Mat,this.matrices.keypoints=new t.KeyPointVector,this.matrices.oldDescriptors=new t.Mat,this.matrices.matches=new t.DMatchVector,this.orb=new t.ORB(500,1.2,5,31,0,2),this.orb.setFastThreshold(40),this.orb.detect(this.matrices.image,this.matrices.keypoints),this.orb.compute(this.matrices.image,this.matrices.keypoints,this.matrices.imageDescriptors),this.bfMatcher=new t.BFMatcher(t.NORM_HAMMING,!0),this.startProcessing()}startProcessing(){if(this.stopped===!0)return;let s=Date.now();this.loadImage(),this.orb.detect(this.matrices.rgba1,this.matrices.keypoints),this.orb.compute(this.matrices.rgba1,this.matrices.keypoints,this.matrices.descriptors),this.first&&(this.matrices.oldDescriptors=this.matrices.descriptors.clone(),this.first=!1),this.bfMatcher.match(this.matrices.descriptors,this.matrices.imageDescriptors,this.matrices.matches);var l=new t.DMatchVector;for(let n=0;n<this.matrices.matches.size();n++)this.matrices.matches.get(n).distance<60&&l.push_back(this.matrices.matches.get(n));p.innerHTML=l.size(),t.drawKeypoints(this.matrices.rgba1,this.matrices.keypoints,this.matrices.rgba2,[0,255,0,255]),t.imshow("displayCanvas",this.matrices.rgba2);let u=1e3/this.FPS-(Date.now()-s);setTimeout(this.startProcessing.bind(this),u)}loadImage(){this.context.drawImage(this.webcam,0,0,this.width,this.height),this.matrices.rgba1.data.set(this.context.getImageData(0,0,this.width,this.height).data)}stopProcessing(){this.stopped=!0;for(let s in this.matrices)this.matrices[s].delete()}}const o=new h;function e(i){m||(o.stopProcessing(),c.video.facingMode==="environment"?c.video.facingMode="user":c.video.facingMode="environment",m=!0,r=g(r),window.startAR())}d.addEventListener("click",()=>{e()}),navigator.mediaDevices.getUserMedia(c).then(function(i){console.log("Loading webcam..."),r.srcObject=i,r.play(),r.addEventListener("loadeddata",()=>{m=!1,o.onVideoLoaded(r)})}).catch(function(i){console.log("An error occurred! "+i)})})};
